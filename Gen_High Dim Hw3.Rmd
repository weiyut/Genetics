---
title: "Hw4 High dim/Gen"
author: "Wei-Yu Tseng"
date: "October 3, 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

## Q1
Load Data
```{r cars}
snp_data <- read.csv("https://raw.githubusercontent.com/xuranw/469_public/master/data/snp_data.csv", row.names = 1)
heart_disease <- snp_data[,1]
snp_data <- snp_data[,-1]
```

### 1A  
Model training  
```{r}
p_values = rep(NA,1167)
for (i in 1:1167) {
  coef = glm(heart_disease ~ snp_data[,i], family = binomial) %>% summary %>% coef()
  p_values[i] = coef[2,4] 
}
```
Graph  
```{r}
par(mfrow = c(1,2))
hist(p_values, breaks = 20, col = "gray", main = 'Histogram of p-values \nwithout correction for ancestry', xlab = 'P-value bin', ylab = 'Frequency')
abline(v = 0.05, lty = 2, col = 'red', lwd = 2)
plot( -log(seq(0, 1, length.out = length(p_values)),10), sort(-log(p_values,10), decreasing = T),
      ylab = "Observed distribution \n(-Log 10 of p-value)", xlab = "Expected distribution \n(-Log 10 of p-value)", main = 'QQ plot of p-values \nwithout correction for ancestry', xlim = c(0,8), ylim = c(0,8), pch = 16)
lines(c(-1,9), c(-1,9), col = "red", lwd = 2)
```
Without ancestry correction, many genes appear to have false association with the disease, many SNPs are significantly related to the disease, casuing the distribution of P-values is heavily right skewed, hence the QQ-plot does not perform well, points are deviating from the diagonal. 

### 1B  

```{r}
pca_res <- stats::prcomp(snp_data, center = T, scale. = T)
plot(pca_res$sdev, ylab = '% of variance accounted for', xlab = 'Components', main = 'Scree plot', pch = 16)
```
Two PCs would be enough because starting at 3rd PC, the % of variance accounted for are similarily small compared to ther first 2 PCs. The first two PCs already contribute to more than 15% variance of the data and also looks like the elbow point of the screeplot.

### 1C  

```{r}
col = heart_disease + 1
plot(pca_res$x[,1], pca_res$x[,2], asp = T, xlab = "Principal component 1", ylab = "Principal component 2", main = 'PCA results', pch = 16, col = col)
legend('topright', c('Does not have CHD', 'Has CHD'), pch = c(15,15), col = c(1,2), bty = "n")
```
Different ancestries seem to cluster in different area, so if we take these groups into account, the false asscociations between SNPs and the disease may be corrected.   

### 1D
```{r}
A_1 = pca_res$x[,1]
A_2 = pca_res$x[,2]
p_values_adj = rep(NA,1167)
for (i in 1:1167) {
  coef = glm(heart_disease ~ snp_data[,i] + A_1 + A_2 , family = binomial) %>% summary %>% coef()
  p_values_adj[i] = coef[2,4] 
}
```
```{r}
par(mfrow = c(1,2))
hist(p_values_adj, breaks = 20, col = "gray", main = 'Histogram of p-values \nwith correction for ancestry', xlab = 'P-value bin', ylab = 'Frequency')
abline(v = 0.05, lty = 2, col = 'red', lwd = 2)
plot( -log(seq(0, 1, length.out = length(p_values_adj)),10), sort(-log(p_values_adj,10), decreasing = T),
      ylab = "Observed distribution \n(-Log 10 of p-value)", xlab = "Expected distribution \n(-Log 10 of p-value)", main = 'QQ plot of p-values \nwith correction for ancestry', xlim = c(0,3.3), ylim = c(0,4), pch = 16)
lines(c(-1,9), c(-1,9), col = "red", lwd = 2)
```
After adjusting the model for ancestry correction, false asscociation between SNPs and the disease have been removed. 
That said, the p-value distribution should beuniform, with a small spike, because most genes were expected to not be associated with the disease.
After the correction , the points in QQ-plot tend to converge to the diagonal.
  
## Q2
Load Data

```{r}
source("https://raw.githubusercontent.com/xuranw/469_public/master/hw3/hw3_functions.R")
set.seed(10) 
dat <- generate_data()
first_pc <- stats::prcomp(dat)$x[,1]
```

### 2A
```{r}
((dat %*% svd(dat)$v[,1] - first_pc) %>% round(3))^2 %>% 
  sum %>%
  sqrt()
```
The euclidean distance between the PC generated by SVD method and the PC generated by the prcomp function is zero. Hence, there is no difference between them.  
```{r}
eigen_res <- eigen(stats::cov(dat), symmetric = FALSE)
((dat %*% eigen_res$vectors[,1] - first_pc) %>% round(3))^2 %>% 
  sum %>%
  sqrt()
```
The euclidean distance between the PC generated by eigen decomposition and the PC generated by the prcomp function is zero. Hence, there is no difference between them.  

```{r}
eigen_res$values[1]
```
The first eigenvalue $\lambda_1$ is approximately 1.67. 

### 2B
**compute_variance function**  
```{r}
compute_variance <- function(x, w){
  x %*% w %*% t(w) %>% 
    var %>%
    diag %>%
    sum() %>%
    round(2)
}
```
x represents our data and w represents the eigenvector or direction.  
   
  
**compute_reconstruction function**
```{r}
compute_reconstruction<- function(x,w){
 (x %*% w %*% t(w) - dat)^2 %>% 
    sum %>% 
    sqrt %>%
    round(2)
}
```
x represents our data and w represents the eigenvector or direction.  
   
  
Graph    
```{r}
plot(dat, pch = 16, xlab = 'Dimension 1', ylab = 'Dimension 2', xlim = c(-4,4), main = paste('PCA: Variance:',compute_variance(dat, eigen_res$vectors[,1]), '\nReconstruction:',compute_reconstruction(dat, eigen_res$vectors[,1])))
points(dat %*% eigen_res$vectors[,1] %*% t(eigen_res$vectors[,1]), col = 'red', pch = 16)
legend('topright', c('Original', '(PCA) Projection'), pch = c(15,15), col = c(1,2), bty = "n")
```
The eigenvalue $\lambda_1$ is equivalent to the variance explained by the first PC.  

### 2C
```{r}
set.seed(10)
e = generate_random_direction()
plot(dat, pch = 16, xlab = 'Dimension 1', ylab = 'Dimension 2', xlim = c(-4,4), main = paste('PCA: Variance:',compute_variance(dat, e), '\nReconstruction:',compute_reconstruction(dat, e)))
points(dat %*% e %*% t(e), col = 'green', pch = 16)
legend('topright', c('Original', 'Random Projection'), pch = c(15,15), col = c(1,'green'), bty = "n")
```

The unit vector is randomly selected, unlike PC1 which is prioritized to captured most of variation among all PCs, it explained relatively less variance than PC1.
In addition, because it captured less variance, it's projection is also farther to the real data compared to PC1, therefore the reconstruction (euclidean distance between projection and original data) is also larger.  

### 2D  
Simulation  
```{r}
variance = list()
reconstruction = list()
for (i in 1:1000){
  e = generate_random_direction()
  variance = c(variance, compute_variance(dat,e))
  reconstruction = c(reconstruction, compute_reconstruction(dat, e))
}
```
Graphs  
```{r}
par(mfrow = c(1,2))
hist(reconstruction%>% as.numeric, breaks = 30, col = 'gray', xlab = 'Value', main = 'Reconstruction \nerror of projected data')
abline(v = compute_reconstruction(dat, eigen_res$vectors[,1]), lty = 2, col = 'red', lwd = 2)
hist(variance%>% as.numeric, breaks = 30, col = 'gray', xlab = 'Value', main = 'Variance of projected \ndata')
abline(v = compute_variance(dat, eigen_res$vectors[,1]), lty = 2, col = 'red', lwd = 2)

```

Because PC1 is designed to explained the most variance among all PC, we can see that the variance of PC1 projection in on the very right side(largest) of the histogram.  
In addition, due to the same reason, the projection of PC1 should be the closet to original data, hence its reconstruction is the smallest, or the right most value in the histogram of reconstruction.  